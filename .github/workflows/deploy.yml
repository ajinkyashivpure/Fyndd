name: Deploy Spring Boot Backend to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Deploy to EC2
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        
        ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts
        
        ssh \
          -o StrictHostKeyChecking=no \
          -o ServerAliveInterval=60 \
          -o ServerAliveCountMax=30 \
          -o TCPKeepAlive=yes \
          -o ConnectTimeout=60 \
          -T \
          ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
        
        set -e
        
        echo "Starting deployment..."

        cd ${{ secrets.PROJECT_DIR }}
        git fetch origin
        git reset --hard origin/main
        
        cd backend
        echo "Building backend..."

        # Less verbose output to avoid SSH overflow
        mvn -q clean package -DskipTests

        # Kill existing app
        pkill -f 'backend-0.0.1-SNAPSHOT.jar' || true
        sleep 5

        # Restart app
        nohup java -jar target/backend-0.0.1-SNAPSHOT.jar > ../app.log 2>&1 &

        echo "Deployment done!"

        EOF
